version: '3.8'
services:
  dispatch-relay:
    build: https://github.com/berkeley-neighbors/dispatch-relay.git#main
    environment:
      - MONGO_CONNECTION_STR=mongodb://user:pass@mongodb:27017
      - AUTH_TOKEN=your_auth_token
      - PORT=4514
      - TWILIO_ACCOUNT_SID=1234
      - TWILIO_AUTH_TOKEN=4567
      - GIN_MODE=release
      - NOTIFICATION_METHODS=SMS,CALL
      - SMS_STAFF_MESSAGE_TEMPLATE=Someone has sent a message
      - SMS_SENDER_RESPONSE_MESSAGE=Thank you for your message. Our team has been notified and will respond shortly.
      - VOICE_MISSED_CALL_STAFF_MESSAGE=MISSED EMERGENCY CALL
      - VOICE_MISSED_CALL_CALLER_MESSAGE=We noticed we missed your emergency call. Please call back or send a text message.
      - VOICE_CONNECTING_MESSAGE=Connecting you to emergency dispatch. Please hold.
      - NOTIFICATION_STRATEGY=ALWAYS
    ports:
      - "4514:4514"
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    
  mongodb:
    image: mongo:6.0
    environment:
      - MONGO_INITDB_ROOT_USERNAME=user
      - MONGO_INITDB_ROOT_PASSWORD=pass
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
        
volumes:
  mongo-data:
    driver: local